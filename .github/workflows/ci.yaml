# CI: deploys to dev

# Required secrets:
# CF_ACCOUNT_ID: Account ID for Cloudflare Workers
# CF_API_TOKEN: API token for Cloudflare (for the Workers CLI)
# AZURE_STORAGE_ACCOUNT: Name of the Azure Storage Account
# AZURE_CLIENT_ID: Client ID for the Azure AD application with access to the Azure Storage account. We are using OpenID Connect: https://learn.microsoft.com/en-us/azure/developer/github/connect-from-azure

name: 'CI'

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: 'ubuntu-22.04'
    env:
      # Version of Hugo to use
      HUGO_VERSION: '0.110.0'
    steps:
      - name: 'Check out code'
        uses: 'actions/checkout@v3'

      - name: 'Install Node.js'
        uses: 'actions/setup-node@v3'
        with:
          node-version: '18.x'

      - name: 'Install Hugo'
        run: |
          cd /tmp
          echo "Using Hugo ${HUGO_VERSION}"
          curl -fsSL "https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_Linux-64bit.tar.gz" -o hugo.tar.gz
          tar -zxf hugo.tar.gz
          sudo mv hugo /usr/local/bin

      - name: 'Install azcopy and authenticate'
        run: |
          cd /tmp
          curl -Ls "https://aka.ms/downloadazcopy-v10-linux" -o azcopy.tar.gz
          tar -xvzf azcopy.tar.gz --strip 1
          sudo mv azcopy /usr/local/bin
          azcopy --version
          azcopy login \
            --identity \
            --identity-client-id $AZURE_CLIENT_ID
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}

      - name: 'Build app'
        run: |
          make dist

      - name: 'Upload static assets to Azure Storage'
        run: |
          # Upload assets to Azure Storage
          ./sync-assets.sh
          # Delete the assets from disk so they're not uploaded to Cloudflare or published as artifact
          for asset in $ASSETS; do rm -rvf "$asset"; done
        env:
          # List of assets to upload
          ASSETS: 'public/images public/fonts'
          # Container in Azure Storage
          CONTAINER: 'withblueink-dev'
          # Use azcopy downloaded above
          AZCOPYCMD: '/usr/local/bin/azcopy'
          # Storage Account name
          AZURE_STORAGE_ACCOUNT: ${{ secrets.AZURE_STORAGE_ACCOUNT }}

      - name: 'Publish app as artifact'
        uses: 'actions/upload-artifact@v3'
        with:
          name: 'app-dev'
          path: 'public'

      - name: 'Install dependencies from NPM'
        working-directory: ./workers-site
        run: npm ci

      - name: 'Deploy to dev environment'
        uses: cloudflare/wrangler-action@2.0.0
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: publish
